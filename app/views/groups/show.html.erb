<!-- レイアウト -->
<style>
.profile-image-chat {
    width: 38px;
    height: 28px;
    object-fit: cover;
}
</style>

<div class="group-show">
  <div class="show-group-chat-back">
    <span class="group-show-group-chat-back">
      <%= link_to groups_path do %>
        ＜
      <% end %>
    </span>
  </div>

  <div class="chat-group-show-talk">
    <h2>トーク</h2>

    <% if @posts.present? %>
      <div class="posts">
        <% @posts.each_with_index do |post, index| %>
          <div class="post">
            <div class="post-content">
              <span class="post-number"><%= index + 1 %>:</span>
              <% if post.customer.present? %>
                <%= link_to customer_path(post.customer), class: "post-customer-link" do %>
                  <% if post.customer.profile_image.attached? %>
                    <%= image_tag post.customer.get_profile_image(230, 230), class: "rounded image-slide-down profile-image-chat" %>
                  <% else %>
                    <%= image_tag "default_profile_image.jpg", class: "rounded-circle", width: 80, height: 80 %>
                  <% end %>
                  <span class="post-customer"><%= post.customer.name %></span>
                <% end %>
              <% else %>
                <span class="post-customer">匿名ユーザー</span>
              <% end %>
              <span class="post-date"><%= post.created_at.strftime("%Y-%m-%d %H:%M:%S") %></span>
            </div>
            <div class="post-comment"><%= post.comment %></div>
            <% if post.image.attached? %>
              <%= image_tag post.image.variant(resize_to_limit: [270, 200]), class: "post-image" %>
            <% end %>
          </div>
          <br>
        <% end %>
      </div>
    <% else %>
      <p>投稿がありません。</p>
    <% end %>

<!-- 参加申請ボタン -->
<% unless @group.customers.include?(current_customer) %>
  <% if @group.join_requests.exists?(customer: current_customer) %>
    <p>・参加申請済みです。オーナーの入室許可が出るまでしばらくお待ちください。
    <br>
    <br>・再度「参加申請」ボタンが表示された場合はオーナーからの入室許可が許可されなかったか、何らかの理由で参加申請に失敗した可能性があります。
    <br>参加申請をご希望の方はもう一度,再度表示された「参加申請」ボタンをクリックしてください。</p>
  <% else %>
    <%= button_to '参加申請', request_join_group_path(@group), method: :post, class: "request-join-button" %>
  <% end %>
<% end %>


<% if current_customer == @group.customers.first %>
        <div class="group-actions">
          <%= link_to '削除', group_path(@group), method: :delete, data: { confirm: '本当に削除しますか?' }, class: "delete-group-link" %>
          <%= link_to '編集', edit_group_path(@group), method: :get, class: "edit-group-link" %>
        </div>
  <div class="join-requests">
    <% @group.join_requests.each do |request| %>
      <div class="join-request">
        <span><%= request.customer.name %> さんの参加申請</span>
        <%= button_to '承認', approve_join_group_path(@group, request_id: request.id), method: :post, class: "approve-join-button" %>
        <%= button_to '拒否', reject_join_group_path(@group, request_id: request.id), method: :post, class: "reject-join-button" %>
        <% if request.status == "rejected" %>
          <% unless @group.customers.include?(current_customer) || @group.join_requests.exists?(customer: current_customer) %>
            <%= button_to '参加申請', request_join_group_path(@group), method: :post, class: "request-join-button" %>
          <% end %>
        <% end %>
      </div>
    <% end %>
  </div>
<% end %>

<% unless current_customer == @group.customers.first || @group.customers.include?(current_customer) || (@group.join_requests.any? && !@group.join_requests.find_by(customer: current_customer).try(:status) == 'approved') %>

<% else %>
  <div class="chat-form">
    <%= form_with(model: [@group, @group.posts.build], local: true, class: "post-form", multipart: true) do |f| %>
      <%= f.text_area :comment, placeholder: "コメント", class: "comment-field" %>
      <%= f.file_field :image %>
      <%= f.submit '投稿', class: "post-button" %>
    <% end %>
  </div>
<% end %>